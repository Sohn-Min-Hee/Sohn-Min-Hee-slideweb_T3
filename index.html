<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ESP32 Potentiometer MiniGame</title>
<style>
  body { margin:0; background:black; color:white; overflow:hidden; }
  .stage { position:relative; width:100vw; height:100vh; }
  .videoLayer {
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    background:black;          /* ë¹ˆ í”„ë ˆì„ ë³´ì • */
    display:none;               /* í•œ ë²ˆì— í•˜ë‚˜ë§Œ ë³´ì´ê²Œ */
  }
  .videoLayer.show { display:block; }
  #pairBtn {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    padding:10px 20px; font-size:18px; z-index:10;
  }
  #gameUI {
    position:absolute; left:50%; bottom:50px; transform:translateX(-50%);
    width:80%; height:30px; background:#333; border-radius:15px;
    overflow:hidden; display:none; z-index:8;
  }
  #gauge { height:100%; width:0%; background:lime; transition:none; }
  #target { position:absolute; top:0; width:4px; height:100%; background:red; }
  #status {
    position:absolute; left:50%; bottom:100px; transform:translateX(-50%);
    font-size:24px; display:none; z-index:9;
  }
  /* í´ë¦­ ì•ˆë‚´(ì„ íƒ) */
  #tapHint {
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    font-size:22px; color:#ddd; z-index:7; user-select:none;
  }
</style>
</head>
<body>

<div class="stage" id="stage">
  <button id="pairBtn">í˜ì–´ë§</button>

  <div id="gameUI">
    <div id="gauge"></div>
    <div id="target"></div>
  </div>
  <div id="status"></div>
  <div id="tapHint">í™”ë©´ì„ í´ë¦­í•˜ë©´ ì‹œì‘í•©ë‹ˆë‹¤</div>

  <!-- ë¹„ë””ì˜¤ 5ê°œë¥¼ ê²¹ì³ë‘ê³  ì „í™˜ë§Œ í•¨ (ë¸”ë™ ë¡œë”© ë°©ì§€) -->
  <video id="vA" class="videoLayer show" src="videoA.mp4" muted loop playsinline preload="auto"></video>
  <video id="vB" class="videoLayer"        src="videoB.mp4" muted      playsinline preload="auto"></video>
  <video id="vC" class="videoLayer"        src="videoC.mp4" muted      playsinline preload="auto"></video>
  <video id="vD" class="videoLayer"        src="videoD.mp4" muted      playsinline preload="auto"></video>
  <video id="vE" class="videoLayer"        src="videoE.mp4" muted      playsinline preload="auto"></video>
</div>

<script>
/* ===== ìƒíƒœ ë³€ìˆ˜ ===== */
let characteristic;
let potValue = 0;          // 0~4095 (ESP32 12bit ê°€ì •)
let gameActive = false;    // ë¯¸ë‹ˆê²Œì„(C) í™œì„± ì—¬ë¶€
let targetValue = 0;       // ëª©í‘œ í¬ì¸íŠ¸(0~4095)
let gameTimer = null;      // 3ì´ˆ íƒ€ì´ë¨¸
let current = 'A';         // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë¹„ë””ì˜¤ í‚¤

/* ===== ì—˜ë¦¬ë¨¼íŠ¸ ===== */
const stage = document.getElementById('stage');
const gameUI = document.getElementById('gameUI');
const gauge  = document.getElementById('gauge');
const target = document.getElementById('target');
const statusBox = document.getElementById('status');
const pairBtn = document.getElementById('pairBtn');
const tapHint = document.getElementById('tapHint');

const videos = {
  A: document.getElementById('vA'),
  B: document.getElementById('vB'),
  C: document.getElementById('vC'),
  D: document.getElementById('vD'),
  E: document.getElementById('vE'),
};

/* ===== ê³µí†µ í•¨ìˆ˜ ===== */
function showVideo(key, {loop=false, fromStart=true} = {}) {
  // ëª¨ë‘ ìˆ¨ê¸°ê³  ëŒ€ìƒë§Œ show
  Object.entries(videos).forEach(([k, vid]) => {
    if (k === key) {
      vid.classList.add('show');
    } else {
      vid.classList.remove('show');
      vid.pause();
    }
  });

  const v = videos[key];
  v.loop = loop;
  if (fromStart) {
    try { v.currentTime = 0; } catch(_) {}
  }
  v.play().catch(()=>{});  // ìë™ì¬ìƒ ë³´ì¥(ìŒì†Œê±°)
  current = key;
}

function showGauge(visible) {
  gameUI.style.display = visible ? 'block' : 'none';
}

function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

/* ===== BLE ì—°ê²° (ê¸°ì¡´ì— ì˜ ë˜ë˜ ë°©ì‹ ìœ ì§€) ===== */
async function connectBLE() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ESP32-Pot" }],
      optionalServices: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"]
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService("4fafc201-1fb5-459e-8fcc-c5c9c331914b");
    characteristic = await service.getCharacteristic("beb5483e-36e1-4688-b7f5-ea07361b26a8");

    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged", handlePotValue);

    console.log("âœ… BLE Connected");
  } catch (err) {
    console.error("âŒ BLE Error:", err);
  }
}

/* ===== í¬í…ì…”ë¯¸í„° ìˆ˜ì‹  ===== */
function handlePotValue(event) {
  const dv = event.target.value; // DataView
  let val = 0;
  try {
    // 2ë°”ì´íŠ¸ê°€ ì˜¤ë©´ 12bit ê°’(0~4095)ë¡œ íŒŒì‹±, 1ë°”ì´íŠ¸ë©´ 0~255 ìŠ¤ì¼€ì¼ë¡œ ì—…ìŠ¤ì¼€ì¼
    if (dv.byteLength >= 2) val = dv.getUint16(0, true);
    else                    val = dv.getUint8(0) * 16; // 0~255 -> 0~4080
  } catch (_) {
    // í˜¹ì‹œ ë¸Œë¼ìš°ì €/ìŠ¤íƒ ì´ìŠˆ ì‹œ ì•ˆì „ ì²˜ë¦¬
    val = 0;
  }
  potValue = clamp(val, 0, 4095);

  // Cì—ì„œë§Œ ê²Œì´ì§€ ë°˜ì˜
  if (gameActive && current === 'C') {
    const percent = (potValue / 4095) * 100;
    gauge.style.width = percent + "%";
  }
}

/* ===== íë¦„ ì»¨íŠ¸ë¡¤ ===== */
function startSequence() {
  tapHint.style.display = 'none';
  statusBox.style.display = 'none';
  showGauge(false);

  // B ì¬ìƒ í›„ ëë‚˜ë©´ C
  showVideo('B', {loop:false});
}

function startMiniGameOnC() {
  // C ì‹œì‘ê³¼ í•¨ê»˜ ë¯¸ë‹ˆê²Œì„ ì‹œì‘
  gameActive = true;
  showGauge(true);
  statusBox.style.display = 'none';

  // ëª©í‘œ ì„¤ì • & ìœ„ì¹˜ í‘œì‹œ
  targetValue = Math.floor(Math.random() * 4095);
  const tPercent = (targetValue / 4095) * 100;
  target.style.left = tPercent + "%";

  // 3ì´ˆ í›„ íŒì •
  clearTimeout(gameTimer);
  gameTimer = setTimeout(() => {
    // C ì¬ìƒ ì¤‘ì¼ ë•Œë§Œ íŒì •(í˜¹ì‹œ ì´ë¯¸ ë„˜ì–´ê°”ìœ¼ë©´ ë¬´ì‹œ)
    if (current === 'C') endGame();
  }, 3000);
}

function endGame() {
  gameActive = false;

  // Cì—ì„œ ë²—ì–´ë‚  ê²ƒì´ë¯€ë¡œ ê²Œì´ì§€ ì¦‰ì‹œ ìˆ¨ê¹€
  showGauge(false);

  const diff = Math.abs(potValue - targetValue);
  if (diff < 100) {
    statusBox.textContent = "ğŸ‰ ì„±ê³µ!";
    showVideo('D', {loop:false});
  } else {
    statusBox.textContent = "âŒ ì‹¤íŒ¨!";
    showVideo('E', {loop:false});
  }
  statusBox.style.display = 'block';
}

function resetToA() {
  statusBox.style.display = 'none';
  showGauge(false);
  showVideo('A', {loop:true});
}

/* ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© ===== */
// ë¹„ë””ì˜¤ ì²´ì¸: B ë â†’ C ì‹œì‘(+ë¯¸ë‹ˆê²Œì„), C ë â†’ (ì•„ì§ íŒì • ì•ˆ í–ˆìœ¼ë©´) íŒì •
videos.B.addEventListener('ended', () => {
  showVideo('C', {loop:false});
  startMiniGameOnC();
});

videos.C.addEventListener('ended', () => {
  // ì•ˆì „ì¥ì¹˜: Cê°€ 3ì´ˆë³´ë‹¤ ì§§ì•„ ëë‚¬ëŠ”ë° ì•„ì§ íŒì • ì•ˆ í–ˆìœ¼ë©´ íŒì •
  if (gameActive) endGame();
});

videos.D.addEventListener('ended', resetToA);
videos.E.addEventListener('ended', resetToA);

// ì•„ë¬´ ì˜ìƒì´ë‚˜ í´ë¦­í•˜ë©´ ì‹œí€€ìŠ¤ ì‹œì‘
Object.values(videos).forEach(v => v.addEventListener('click', startSequence));

// í˜ì–´ë§ ë²„íŠ¼
pairBtn.addEventListener('click', connectBLE);

/* ===== ì´ˆê¸° ì¤€ë¹„ ===== */
// ë¯¸ë¦¬ ë¡œë“œ (ë¸”ë™ë¡œë”© ìµœì†Œí™”)
Object.values(videos).forEach(v => { try { v.load(); } catch(_) {} });
showVideo('A', {loop:true});
</script>
</body>
</html>
