<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ESP32 Potentiometer MiniGame</title>
<style>
body { margin:0; display:flex; flex-direction:column; align-items:center; background:black; color:white; overflow:hidden;}
video { width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; background:black; }
#pairBtn {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  padding:10px 20px; font-size:18px; z-index:10;
}
#gameUI {
  position:absolute; bottom:50px; left:50%; transform:translateX(-50%);
  width:80%; height:30px; background:#333; border-radius:15px;
  overflow:hidden; display:none; z-index:5;
}
#gauge {
  height:100%; width:0%; background:lime;
  transition:none;
}
#target {
  position:absolute; top:0; width:4px; height:100%; background:red;
}
#status {
  position:absolute; bottom:100px; left:50%; transform:translateX(-50%);
  font-size:24px; display:none; z-index:6;
}
</style>
</head>
<body>

<button id="pairBtn">ÌéòÏñ¥ÎßÅ</button>

<div id="gameUI">
  <div id="gauge"></div>
  <div id="target"></div>
</div>

<div id="status"></div>

<video id="videoPlayer" autoplay muted loop playsinline preload="auto">
  <source src="videoA.mp4" type="video/mp4">
</video>

<script>
let characteristic;
let potValue = 0;
let gameActive = false;
let targetValue = 0;
let gameTimer;

const video = document.getElementById("videoPlayer");
const gameUI = document.getElementById("gameUI");
const gauge = document.getElementById("gauge");
const target = document.getElementById("target");
const statusBox = document.getElementById("status");

// üîπ BLE Ïó∞Í≤∞
async function connectBLE() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ESP32-Pot" }],
      optionalServices: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"]
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService("4fafc201-1fb5-459e-8fcc-c5c9c331914b");
    characteristic = await service.getCharacteristic("beb5483e-36e1-4688-b7f5-ea07361b26a8");

    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged", handlePotValue);

    console.log("‚úÖ BLE Connected!");
  } catch (err) {
    console.error("‚ùå BLE Error:", err);
  }
}

// üîπ Ìè¨ÌÖêÏÖîÎØ∏ÌÑ∞ Í∞í Ï≤òÎ¶¨
function handlePotValue(event) {
  const value = event.target.value;
  potValue = value.getUint16(0, true);

  console.log("Pot raw:", new Uint8Array(value.buffer), "Parsed:", potValue);

  if (gameActive) {
    const percent = (potValue / 4095) * 100;
    gauge.style.width = percent + "%";
  }
}

// üîπ Í≤åÏûÑ ÏãúÏûë (ÏòÅÏÉÅ B ‚Üí C ‚Üí ÎØ∏ÎãàÍ≤åÏûÑ)
function startGame() {
  video.src = "videoB.mp4";
  video.loop = false;
  video.onended = () => {
    video.src = "videoC.mp4";
    video.loop = false;
    video.play();
    launchMiniGame();
  };
}

// üîπ ÎØ∏ÎãàÍ≤åÏûÑ (ÏòÅÏÉÅ CÏóêÏÑúÎßå)
function launchMiniGame() {
  gameActive = true;
  gameUI.style.display = "block";
  statusBox.style.display = "none";

  targetValue = Math.floor(Math.random() * 4095);
  const percent = (targetValue / 4095) * 100;
  target.style.left = percent + "%";

  clearTimeout(gameTimer);
  gameTimer = setTimeout(endGame, 3000);

  // üéØ C ÏòÅÏÉÅ ÎÅùÎÇ† Îïå Í≤åÏù¥ÏßÄ Ïà®Í∏∞Í≥† ÌåêÏ†ï Ïã§Ìñâ
  video.onended = () => {
    gameUI.style.display = "none";
    endGame();
  };
}

// üîπ Í≤åÏûÑ Ï¢ÖÎ£å
function endGame() {
  gameActive = false;

  const diff = Math.abs(potValue - targetValue);
  if (diff < 100) {
    statusBox.textContent = "üéâ ÏÑ±Í≥µ!";
    video.src = "videoD.mp4";
  } else {
    statusBox.textContent = "‚ùå Ïã§Ìå®!";
    video.src = "videoE.mp4";
  }
  video.loop = false;
  video.play();
  statusBox.style.display = "block";

  // ÏÑ±Í≥µ/Ïã§Ìå® ÏòÅÏÉÅ ÎÅùÎÇú Îí§ Ï¥àÍ∏∞Ìôî
  video.onended = () => {
    video.src = "videoA.mp4";
    video.loop = true;
    video.play();
    statusBox.style.display = "none";
    gameUI.style.display = "none";
  };
}

// Ïù¥Î≤§Ìä∏
document.getElementById("pairBtn").addEventListener("click", connectBLE);
video.addEventListener("click", startGame);
</script>
</body>
</html>
