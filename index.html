<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ESP32 Potentiometer MiniGame (BLE)</title>
<style>
  html,body{margin:0;height:100%;background:black;color:white;overflow:hidden;}
  .stage{position:relative;width:100vw;height:100vh;}
  .videoLayer{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:cover; background:black; display:none;
  }
  .videoLayer.show{display:block;}
  /* 오버레이는 모바일 비디오 위에 강제 */
  #pairBtn{
    position:fixed; top:10px; left:50%; transform:translateX(-50%);
    padding:10px 20px; font-size:18px; z-index:9999;
  }
  #gameUI{
    position:fixed; left:50%; bottom:50px; transform:translateX(-50%);
    width:80%; height:30px; background:#333; border-radius:15px;
    overflow:hidden; display:none; z-index:9999; pointer-events:none;
  }
  #gauge{height:100%; width:0%; background:lime; transition:none;}
  #target{position:absolute; top:0; width:4px; height:100%; background:red;}
  #status{
    position:fixed; left:50%; bottom:100px; transform:translateX(-50%);
    font-size:24px; display:none; z-index:9999; pointer-events:none;
  }
  #tapHint{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    font-size:20px; color:#ddd; z-index:9999; pointer-events:none;
  }
</style>
</head>
<body>

<div class="stage">
  <button id="pairBtn">페어링</button>
  <div id="gameUI"><div id="gauge"></div><div id="target"></div></div>
  <div id="status"></div>
  <div id="tapHint">화면을 탭하여 시작</div>

  <!-- 다중 비디오(블랙 전환 방지). iOS 인라인 재생 속성 포함 -->
  <video id="vA" class="videoLayer show" src="videoA.mp4" muted loop playsinline webkit-playsinline preload="auto"></video>
  <video id="vB" class="videoLayer"        src="videoB.mp4" muted      playsinline webkit-playsinline preload="auto"></video>
  <video id="vC" class="videoLayer"        src="videoC.mp4" muted      playsinline webkit-playsinline preload="auto"></video>
  <video id="vD" class="videoLayer"        src="videoD.mp4" muted      playsinline webkit-playsinline preload="auto"></video>
  <video id="vE" class="videoLayer"        src="videoE.mp4" muted      playsinline webkit-playsinline preload="auto"></video>
</div>

<script>
let characteristic;
let potValue=0, targetValue=0, gameActive=false, gameTimer=null, current='A';
const pairBtn=document.getElementById('pairBtn');
const gameUI=document.getElementById('gameUI'), gauge=document.getElementById('gauge'), target=document.getElementById('target');
const statusBox=document.getElementById('status'), tapHint=document.getElementById('tapHint');
const videos={ A: vA, B: vB, C: vC, D: vD, E: vE };

function showVideo(key,{loop=false,fromStart=true}={}) {
  Object.entries(videos).forEach(([k,vid])=>{
    vid.classList.toggle('show', k===key);
    if(k!==key) vid.pause();
  });
  const v=videos[key];
  v.loop=loop;
  if(fromStart){ try{ v.currentTime=0; }catch(e){} }
  v.play().catch(()=>{});
  current=key;
}
function showGauge(visible){ gameUI.style.display=visible?'block':'none'; }
function clamp(x,min,max){ return Math.max(min,Math.min(max,x)); }

async function connectBLE(){
  try{
    const device=await navigator.bluetooth.requestDevice({
      filters:[{name:"ESP32-Pot"}],
      optionalServices:["4fafc201-1fb5-459e-8fcc-c5c9c331914b"]
    });
    const server=await device.gatt.connect();
    const svc=await server.getPrimaryService("4fafc201-1fb5-459e-8fcc-c5c9c331914b");
    characteristic=await svc.getCharacteristic("beb5483e-36e1-4688-b7f5-ea07361b26a8");
    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged", handlePot);
    console.log("✅ BLE connected");
  }catch(e){ console.error("❌ BLE", e); }
}
function handlePot(e){
  const dv=e.target.value;
  let v=0;
  try{
    v = dv.byteLength>=2 ? dv.getUint16(0,true) : dv.getUint8(0)*16;
  }catch(_){ v=0; }
  potValue=clamp(v,0,4095);

  if(gameActive && current==='C'){
    const pct=(potValue/4095)*100;
    gauge.style.width=pct+"%";
  }
}

function startFlow(){
  tapHint.style.display='none';
  statusBox.style.display='none';
  showGauge(false);
  showVideo('B',{loop:false});
}
function startMiniGameOnC(){
  gameActive=true;
  showGauge(true);
  statusBox.style.display='none';

  targetValue=Math.floor(Math.random()*4095);
  target.style.left=(targetValue/4095*100)+"%";

  clearTimeout(gameTimer);
  gameTimer=setTimeout(()=>{ if(current==='C') endGame(); },3000);
}
function endGame(){
  gameActive=false;
  showGauge(false);
  const diff=Math.abs(potValue-targetValue);
  if(diff<100){ statusBox.textContent='🎉 성공!'; showVideo('D'); }
  else        { statusBox.textContent='❌ 실패!'; showVideo('E'); }
  statusBox.style.display='block';
}
function resetToA(){
  statusBox.style.display='none';
  showGauge(false);
  showVideo('A',{loop:true});
}

videos.B.addEventListener('ended', ()=>{ showVideo('C'); startMiniGameOnC(); });
videos.C.addEventListener('ended', ()=>{ if(gameActive) endGame(); });
videos.D.addEventListener('ended', resetToA);
videos.E.addEventListener('ended', resetToA);

// 아무 영상 탭 → 시작
Object.values(videos).forEach(v=> v.addEventListener('click', startFlow));
pairBtn.addEventListener('click', connectBLE);

// 미리 로드
Object.values(videos).forEach(v=>{ try{ v.load(); }catch(_){} });
showVideo('A',{loop:true});
</script>
</body>
</html>
